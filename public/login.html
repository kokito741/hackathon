<!DOCTYPE html>
<html>
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon">
<title>Login</title>
</head>  
<body>
<h2>Login</h2>
<form id="f">
  <input name="email" placeholder="Email">Email<br>
  <input name="password" type="password" placeholder="Password">password<br>
  <button type="submit">Login</button>
</form>
<button id="registerBtn" type="button">Register</button>

<script>
const form = document.getElementById('f');
window.addEventListener('error', e => {
  if(e.message.includes('__cf_bm')) e.preventDefault();
});
// Clear any old token on page load
try {
  const oldToken = localStorage.getItem('token');
  if (oldToken) {
    localStorage.removeItem('token');
    console.log('Old token cleared:', oldToken);
  }
} catch(e) {
  console.error('Cannot access localStorage:', e);
}

form.onsubmit = async e => {
  e.preventDefault();
  const f = e.target;
  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({email: f.email.value, password: f.password.value})
  });
  const data = await res.json();
  if(data.token){
    localStorage.setItem('token', data.token);
    console.log('New token stored:', data.token);
    location.href = '/home';
  } else alert(data.error);
};

// Register button
document.getElementById('registerBtn').onclick = () => {
  location.href = '/register';
};
</script>
</body>
</html>
